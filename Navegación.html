<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Cuentas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const Check = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"></polyline></svg>;
    const Edit2 = ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>;
    const Save = ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
    const RotateCcw = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>;
    const Download = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
    const Upload = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
    const FileText = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>;
    const Database = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>;
    const Clock = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
    const Search = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>;
    const Filter = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;

    function App() {
      const [phones, setPhones] = useState([]);
      const [editingPhone, setEditingPhone] = useState(null);
      const [editingAccount, setEditingAccount] = useState(null);
      const [editingNote, setEditingNote] = useState(null);
      const [tempName, setTempName] = useState('');
      const [tempNote, setTempNote] = useState('');
      const [saveStatus, setSaveStatus] = useState('');
      const [isLoading, setIsLoading] = useState(true);
      const [showDatabase, setShowDatabase] = useState(false);
      const [showHistory, setShowHistory] = useState(false);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterStatus, setFilterStatus] = useState('all');

      const initializeDefaultPhones = () => {
        const defaultPhones = Array.from({ length: 9 }, (_, i) => ({
          id: i + 1,
          name: `Celular ${i + 1}`,
          note: '',
          accounts: Array.from({ length: 5 }, (_, j) => ({
            id: j + 1,
            name: `Cuenta ${j + 1}`,
            round1: false,
            round2: false,
            round1Date: null,
            round2Date: null
          }))
        }));
        setPhones(defaultPhones);
      };

      useEffect(() => {
        try {
          const saved = localStorage.getItem('phones-data');
          if (saved) setPhones(JSON.parse(saved));
          else initializeDefaultPhones();
        } catch { initializeDefaultPhones(); }
        finally { setIsLoading(false); }
      }, []);

      useEffect(() => {
        if (!isLoading && phones.length > 0) {
          const t = setTimeout(() => localStorage.setItem('phones-data', JSON.stringify(phones)), 500);
          return () => clearTimeout(t);
        }
      }, [phones, isLoading]);

      const saveData = () => {
        try {
          setSaveStatus('Guardando...');
          localStorage.setItem('phones-data', JSON.stringify(phones));
          setSaveStatus('✓ Guardado');
          setTimeout(() => setSaveStatus(''), 3000);
        } catch {
          setSaveStatus('✗ Error');
          setTimeout(() => setSaveStatus(''), 3000);
        }
      };

      const toggleCheck = (phoneId, accountId, round) => {
        setPhones(phones.map(phone => phone.id === phoneId ? {
          ...phone,
          accounts: phone.accounts.map(acc => acc.id === accountId ? {
            ...acc,
            [round]: !acc[round],
            [`${round}Date`]: !acc[round] ? new Date().toISOString() : null
          } : acc)
        } : phone));
      };

      const savePhoneName = (phoneId) => {
        if (tempName.trim()) setPhones(phones.map(p => p.id === phoneId ? {...p, name: tempName.trim()} : p));
        setEditingPhone(null);
        setTempName('');
      };

      const saveAccountName = (phoneId, accountId) => {
        if (tempName.trim()) setPhones(phones.map(p => p.id === phoneId ? {
          ...p,
          accounts: p.accounts.map(a => a.id === accountId ? {...a, name: tempName.trim()} : a)
        } : p));
        setEditingAccount(null);
        setTempName('');
      };

      const saveNote = (phoneId) => {
        setPhones(phones.map(p => p.id === phoneId ? {...p, note: tempNote} : p));
        setEditingNote(null);
        setTempNote('');
      };

      const resetAll = () => setPhones(phones.map(p => ({...p, accounts: p.accounts.map(a => ({...a, round1: false, round2: false, round1Date: null, round2Date: null}))})));

      const exportToExcel = () => {
        let csv = 'Celular,Cuenta\n';
        phones.forEach(p => p.accounts.forEach(a => csv += `"${p.name}","${a.name}"\n`));
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `cuentas_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
      };

      const createBackup = () => {
        const backup = {version: '1.0', date: new Date().toISOString(), data: phones};
        const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        setSaveStatus('✓ Backup creado');
        setTimeout(() => setSaveStatus(''), 3000);
      };

      const restoreBackup = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const backup = JSON.parse(ev.target.result);
              if (backup.data) {
                setPhones(backup.data);
                localStorage.setItem('phones-data', JSON.stringify(backup.data));
                setSaveStatus('✓ Restaurado');
              } else setSaveStatus('✗ Inválido');
              setTimeout(() => setSaveStatus(''), 3000);
            } catch {
              setSaveStatus('✗ Error');
              setTimeout(() => setSaveStatus(''), 3000);
            }
          };
          reader.readAsText(file);
        }
      };

      const formatDate = (d) => d ? new Date(d).toLocaleString('es-ES', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}) : 'No completado';

      const getFilteredPhones = () => {
        let f = phones;
        if (searchTerm) f = f.map(p => ({...p, accounts: p.accounts.filter(a => p.name.toLowerCase().includes(searchTerm.toLowerCase()) || a.name.toLowerCase().includes(searchTerm.toLowerCase()))})).filter(p => p.accounts.length > 0);
        if (filterStatus !== 'all') f = f.map(p => ({...p, accounts: p.accounts.filter(a => {
          if (filterStatus === 'r1-pending') return !a.round1;
          if (filterStatus === 'r1-done') return a.round1;
          if (filterStatus === 'r2-pending') return !a.round2;
          if (filterStatus === 'r2-done') return a.round2;
          if (filterStatus === 'both-done') return a.round1 && a.round2;
          if (filterStatus === 'none-done') return !a.round1 && !a.round2;
          return true;
        })})).filter(p => p.accounts.length > 0);
        return f;
      };

      const filteredPhones = getFilteredPhones();
      const getTotalProgress = (r) => `${phones.reduce((s,p) => s + p.accounts.filter(a => a[r]).length, 0)}/45`;

      if (isLoading) return <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-700 flex items-center justify-center"><div className="text-white text-xl">Cargando...</div></div>;

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-700 p-4">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-xl shadow-2xl p-4 md:p-6 mb-4">
              <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                <h1 className="text-2xl md:text-3xl font-bold text-gray-800">Control de Cuentas</h1>
                <div className="flex gap-2 flex-wrap text-sm">
                  {saveStatus && <span className="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg">{saveStatus}</span>}
                  <button onClick={() => setShowHistory(!showHistory)} className="px-3 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 flex items-center gap-2"><Clock/>Historial</button>
                  <button onClick={() => setShowDatabase(!showDatabase)} className="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 flex items-center gap-2"><Database/>BD</button>
                  <button onClick={createBackup} className="px-3 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 flex items-center gap-2"><Download/>Backup</button>
                  <label className="px-3 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 flex items-center gap-2 cursor-pointer"><Upload/>Restaurar<input type="file" accept=".json" onChange={restoreBackup} className="hidden"/></label>
                  <button onClick={saveData} className="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2"><Save/>Guardar</button>
                  <button onClick={exportToExcel} className="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2"><Download/>Excel</button>
                  <button onClick={resetAll} className="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center gap-2"><RotateCcw/>Reiniciar</button>
                </div>
              </div>
              <div className="grid md:grid-cols-2 gap-4 mb-4">
                <div className="relative"><Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"/><input type="text" placeholder="Buscar..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"/></div>
                <div className="relative"><Filter className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"/><select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="w-full pl-10 pr-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none bg-white"><option value="all">Todas</option><option value="r1-pending">R1 Pendientes</option><option value="r1-done">R1 Completadas</option><option value="r2-pending">R2 Pendientes</option><option value="r2-done">R2 Completadas</option><option value="both-done">Ambas</option><option value="none-done">Ninguna</option></select></div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-blue-50 p-3 rounded-lg border-2 border-blue-200"><h3 className="font-semibold text-blue-800 text-sm">Ronda 1</h3><p className="text-xl font-bold text-blue-600">{getTotalProgress('round1')}</p></div>
                <div className="bg-green-50 p-3 rounded-lg border-2 border-green-200"><h3 className="font-semibold text-green-800 text-sm">Ronda 2</h3><p className="text-xl font-bold text-green-600">{getTotalProgress('round2')}</p></div>
              </div>
            </div>

            {showHistory && (
              <div className="bg-white rounded-xl shadow-2xl p-4 mb-4">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Historial</h2>
                <div className="overflow-auto max-h-96"><table className="w-full border-collapse text-sm"><thead className="sticky top-0 bg-gray-100"><tr><th className="border border-gray-300 px-4 py-2 text-left">Celular</th><th className="border border-gray-300 px-4 py-2 text-left">Cuenta</th><th className="border border-gray-300 px-4 py-2 text-left">R1</th><th className="border border-gray-300 px-4 py-2 text-left">R2</th></tr></thead><tbody>{phones.map(p => p.accounts.map(a => <tr key={`${p.id}-${a.id}`} className="hover:bg-gray-50"><td className="border border-gray-300 px-4 py-2">{p.name}</td><td className="border border-gray-300 px-4 py-2">{a.name}</td><td className="border border-gray-300 px-4 py-2"><span className={a.round1 ? 'text-green-600' : 'text-gray-400'}>{formatDate(a.round1Date)}</span></td><td className="border border-gray-300 px-4 py-2"><span className={a.round2 ? 'text-green-600' : 'text-gray-400'}>{formatDate(a.round2Date)}</span></td></tr>))}</tbody></table></div>
              </div>
            )}

            {showDatabase && (
              <div className="bg-white rounded-xl shadow-2xl p-4 mb-4">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Base de Datos</h2>
                <div className="overflow-auto"><table className="w-full border-collapse text-sm"><thead><tr className="bg-gray-100"><th className="border border-gray-300 px-4 py-2 text-left">Celular</th><th className="border border-gray-300 px-4 py-2 text-left">Cuenta</th></tr></thead><tbody>{phones.map(p => p.accounts.map((a,i) => <tr key={`${p.id}-${a.id}`} className="hover:bg-gray-50"><td className="border border-gray-300 px-4 py-2">{i===0?p.name:''}</td><td className="border border-gray-300 px-4 py-2">{a.name}</td></tr>))}</tbody></table></div>
              </div>
            )}

            <div className="md:grid md:grid-cols-2 lg:grid-cols-4 md:gap-4 flex overflow-x-auto gap-4 snap-x pb-4 scrollbar-hide">
              {filteredPhones.map(phone => {
                const orig = phones.find(p => p.id === phone.id);
                return (
                  <div key={phone.id} className="bg-white rounded-xl shadow-lg p-4 min-w-[85vw] md:min-w-0 snap-center">
                    <div className="mb-3 pb-3 border-b-2">
                      {editingPhone === phone.id ? (
                        <div className="flex gap-2"><input type="text" value={tempName} onChange={(e) => setTempName(e.target.value)} onKeyPress={(e) => e.key==='Enter' && savePhoneName(phone.id)} className="flex-1 px-2 py-1 border-2 border-blue-500 rounded text-sm" autoFocus/><button onClick={() => savePhoneName(phone.id)} className="p-1 bg-blue-500 text-white rounded"><Save/></button></div>
                      ) : (
                        <div className="flex justify-between items-center"><h2 className="text-lg font-bold">{phone.name}</h2><button onClick={() => {setEditingPhone(phone.id);setTempName(phone.name);}} className="p-1 text-gray-500 hover:text-blue-500"><Edit2/></button></div>
                      )}
                    </div>
                    <div className="mb-3 pb-3 border-b-2">
                      {editingNote === phone.id ? (
                        <div className="flex flex-col gap-2"><textarea value={tempNote} onChange={(e) => setTempNote(e.target.value)} className="w-full px-2 py-1 border-2 border-blue-500 rounded text-xs" rows="3" autoFocus/><button onClick={() => saveNote(phone.id)} className="self-end px-3 py-1 bg-blue-500 text-white rounded text-xs"><Save size={12}/>Guardar</button></div>
                      ) : (
                        <div onClick={() => {setEditingNote(phone.id);setTempNote(orig.note||'');}} className="cursor-pointer hover:bg-gray-50 p-2 rounded"><div className="flex items-center gap-2 mb-1"><FileText/><span className="text-xs font-medium">Notas</span></div><p className="text-xs text-gray-500 italic min-h-[40px]">{orig.note||'Click para notas...'}</p></div>
                      )}
                    </div>
                    <div className="space-y-2">
                      {phone.accounts.map(acc => (
                        <div key={acc.id} className="bg-gray-50 rounded-lg p-2">
                          {editingAccount === `${phone.id}-${acc.id}` ? (
                            <div className="flex gap-1 mb-2"><input type="text" value={tempName} onChange={(e) => setTempName(e.target.value)} onKeyPress={(e) => e.key==='Enter' && saveAccountName(phone.id,acc.id)} className="flex-1 px-2 py-1 border border-blue-500 rounded text-xs" autoFocus/><button onClick={() => saveAccountName(phone.id,acc.id)} className="p-1 bg-blue-500 text-white rounded"><Save size={14}/></button></div>
                          ) : (
                            <div className="flex justify-between items-center mb-2"><span className="text-sm font-medium">{acc.name}</span><button onClick={() => {setEditingAccount(`${phone.id}-${acc.id}`);setTempName(acc.name);}} className="p-1 text-gray-400 hover:text-blue-500"><Edit2 size={12}/></button></div>
                          )}
                          <div className="flex gap-2">
                            <button onClick={() => toggleCheck(phone.id,acc.id,'round1')} className={`flex-1 py-1 rounded border-2 flex items-center justify-center gap-1 ${acc.round1?'bg-blue-500 text-white':'bg-white border-gray-300 hover:border-blue-400'}`}>{acc.round1 && <Check/>}<span className="text-xs">R1</span></button>
                            <button onClick={() => toggleCheck(phone.id,acc.id,'round2')} className={`flex-1 py-1 rounded border-2 flex items-center justify-center gap-1 ${acc.round2?'bg-green-500 text-white':'bg-white border-gray-300 hover:border-green-400'}`}>{acc.round2 && <Check/>}<span className="text-xs">R2</span></button>
                          </div>
                        </div>
                      ))}
                    </div>
                    <div className="mt-3 pt-3 border-t-2 text-xs text-gray-600"><div className="flex justify-between"><span>R1: {phone.accounts.filter(a=>a.round1).length}/{phone.accounts.length}</span><span>R2: {phone.accounts.filter(a=>a.round2).length}/{phone.accounts.length}</span></div></div>
                  </div>
                );
              })}
            </div>
            {filteredPhones.length === 0 && <div className="bg-white rounded-xl p-8 text-center"><p className="text-gray-500">No hay resultados</p></div>}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>
